# SQL Injection

Q. ****SQL Injection이란?****

<img width="500" src="https://t1.daumcdn.net/cfile/tistory/9920763C5C8890FB1A">

- SQL Injection 이란 악의적인 사용자가 보안상의 취약점을 이용하여, 임의의 SQL 문을 주입하고 실행해서 데이터베이스가 비정상적인 동작을 하도록 조작하는 행위
- 인젝션 공격은 OWASP Top10 중 첫 번째에 속해 있으며, 공격이 비교적 쉬운 편이고 공격에 성공할 경우 큰 피해를 입힐 수 있음
    - OWASP: 오픈소스 웹 어플리케이션 보안 프로젝트로 10대 웹 어플리케이션 취약점을 연구하고 발표함

<img width="500" src="https://t1.daumcdn.net/cfile/tistory/99D4993C5C8890FB1D">

**예시 - 여기어때 해킹 사건**

- 2017년 3월에 일어난 “여기어때” 의 대규모 개인정보 유출 사건도 SQL Injection 으로 인해 피해가 발생함

**Q. 공격 종류 및 방법**

A.

- **Error based SQL Injection: `논리적 에러를 이용한 SQL Injection`**

⇒ 가장 많이 쓰이고, 대중적인 공격 기법임

<img width="500" src="https://t1.daumcdn.net/cfile/tistory/9958373C5C8890FA03">

위의 사진에서 보이는 쿼리문은 일반적으로 로그인 시 많이 사용되는 SQL 구문입니다. 

해당 구문에서 입력값에 대한 검증이 없음을 확인하고, 악의적인 사용자가 임의의 SQL 구문을 주입하고 있음

주입된 내용은 `‘ OR 1=1 --` 로  WHERE 절에 있는 싱글쿼터를 닫아주기 위한 싱글쿼터와 OR 1=1 라는 구문을 이용해 WHERE 절을 모두 참으로 만들고, 

-- 를 넣어줌으로 뒤의 구문을 모두 주석 처리함

매우 간단한 구문이지만, 결론적으로 Users 테이블에 있는 모든 정보를 조회하게 됨으로써 

가장 먼저 만들어진 계정으로 로그인에 성공하게 됩니다. 

⇒ 보통은 관리자 계정을 맨 처음 만들기 때문에 관리자 계정에 로그인 할 수 있게 됨

⇒ 관리자 계정을 탈취한 악의적인 사용자는 관리자의 권한을 이용해 또 다른 2차 피해를 발생 시킬 수 있게 됩니다.

**Union based SQL Injection: `Union 명령어를 이용한 SQL Injection`**

Union 키워드: 두 개의 쿼리문에 대한 결과를 통합해서 하나의 테이블로 보여주게 하는 키워드 입니다. (합집합)

**결과**

정상적인 쿼리문에 Union 키워드를 사용하여 인젝션에 성공하면, 원하는 쿼리문을 실행할 수 있게 됩니다. 

**조건**

 1. 하나는 Union 하는 두 테이블의 컬럼 수가 같아야 함

1. 데이터 형이 같아야 함

<img width="500" src="https://t1.daumcdn.net/cfile/tistory/99BD4C3C5C8890FA0A">

**예시**

위의 사진에서 보이는 쿼리문은 Board 라는 테이블에서 게시글을 검색하는 쿼리문입니다. 입력값을 title 과 contents 컬럼의 데이터랑 비교한 뒤 비슷한 글자가 있는 게시글을 출력합니다. 

여기서 입력값으로 Union 키워드와 함께 컬럼 수를 맞춰서 SELECT 구문을 넣어주게 되면 두 쿼리문이 합쳐서서 하나의 테이블로 보여지게 됩니다. 

- 현재 인젝션 한 구문은 사용자의 id와 passwd를 요청하는 쿼리문
- 인젝션이 성공하게 되면, 사용자의 개인정보가 게시글과 함께 화면에 보여지게 됩니다.

이 공격도 역시 입력값에 대한 검증이 없기 때문에 발생하게 되었습니다.

### **대응방안**

1) **입력 값에 대한 검증: `서버 단에서 화이트리스트 기반 검증`**

- 사용자의 입력 값에 대한 검증이 필요하고, 서버 단에서 화이트리스트 기반으로 검증해야 함
- 화이트리스트: 통과하는 것만 적어두는 방식, 블랙리스트: 통과하지 못하는 것만 적어두는 방식
- 블랙리스트 기반으로 검증하게 되면 수많은 차단리스트를 등록해야 하고, 하나라도 빠지면 공격에 성공하게 되기 때문

2) **Prepared Statement 구문사용**

- Prepared Statement 구문을 사용하게 되면, 사용자의 입력 값이 데이터베이스의 파라미터로 들어가기 전에 DBMS가 미리 컴파일 하여 실행하지 않고 대기합니다.
- 쿼리문에서 parameter를 `?`로 받아서 서버측에서 필터링 과정을 통해 공격을 막아냄
- 공격쿼리가 들어간다고 하더라도, 사용자의 입력은 이미 의미 없는 단순 문자열 이기 때문에 전체 쿼리문도 공격자의 의도대로 작동하지 않습니다.

3) **Error Message 노출 금지**

- 공격자가 SQL Injection을 수행하기 위해서는 데이터베이스의 정보(테이블명, 컬럼명 등)가 필요함
- 데이터베이스 에러 발생 시 따로 처리를 해주지 않았다면, 에러가 발생한 쿼리문과 함께 에러에 관한 내용을 반환해 줌
- 여기서 테이블명 및 컬럼명 그리고 쿼리문이 노출이 될 수 있기 때문에, 데이터 베이스에 대한 오류발생 시 사용자에게 보여줄 수 있는 페이지를 제작 혹은 메시지박스를 띄워야 함

### 참고자료

- [SQL Injection 이란? (SQL 삽입 공격) — 보안과 개발을 다 하고싶은 욕심쟁이 (tistory.com)](https://noirstar.tistory.com/264)
