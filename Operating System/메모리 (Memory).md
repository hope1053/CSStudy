# 메모리 (Memory)

### **메인 메모리(main memory)**

- 메인 메모리는 CPU가 직접 접근할 수 있는 기억 장치
- 프로세스가 실행되려면 프로그램이 메모리에 올라와야 함
- 주소가 할당된 일련의 바이트들로 구성되어 있음

CPU는 `PC(Program Counter)`가 지시하는대로 메모리에 접근하여 다음에 수행할 명령어를 가져옴

명령어 수행 시 메모리에 필요한 데이터가 없으면 해당 데이터를 우선 가져와야 함 (`Load` 명령어) 

이 역할을 하는 것이 바로 MMU

### MMU, Memory Management Unit

- 메모리 관리장치(`MMU`)는 논리 주소를 물리주소로 변환해준다.
- 프로그램에 의해 생성된 모든 논리 주소 집합을 논리 주소 공간 (`Logical address space`) 라고 하며, 이 논리 주소와 일치하는 물리 주소 집합을 물리 주소 공간(`Physical address space`)이라고 한다.
- 프로그램을 실행할 때는 가상 주소를 물리 주소로 바꿔 줘야 하는데 이 변환 작업(맵핑하는 작업)을 하드웨어 장치인 메모리 관리기 (MMU, `Memory Management Unit`)가 담당한다.

![Untitled (100)](https://user-images.githubusercontent.com/71035113/156919116-d8b82887-41e1-4aa9-9952-536a0721022d.png)

- 사용자 프로그램은 실제적인 물리 주소를 알 수 없기 때문에 베이스 레지스터에 대해 다시 바인딩 된다.
- 이때 베이스 레지스터를 재배치(relocation) 레지스터라 한다.

![Untitled - 2022-03-06T192514 768](https://user-images.githubusercontent.com/71035113/156919117-428ea2f3-4dff-4d20-a52e-db0ff14fc84d.png)

- MMU는 뿐만 아니라 `메모리 보호`나 `캐시 관리` 등 CPU가 메모리에 접근하는 것을 총 관리해주는 하드웨어임

### **MMU의 메모리 보호**

- 프로세스는 독립적인 메모리 공간을 가져야 되고, 자신의 공간만 접근해야 함

(프로세스는 프로세스 간 메모리 공유 안하는 반면, 스레드는 공유한다고 앞에서 다뤘음)

- 따라서 한 프로세스에게 합법적인 주소 영역을 설정하고, 잘못된 접근이 오면 `trap`을 발생시키며 보호함
- base와 limit 레지스터를 활용한 메모리 보호 기법
- base 레지스터는 메모리상의 프로세스 시작주소를 물리 주소로 저장
- limit 레지스터는 프로세스의 사이즈를 저장
- 이로써 프로세스의 접근 가능한 합법적인 메모리 영역(x)은 `base <= x < base+limit`
- 이 영역 밖에서 접근을 요구하면 `trap`을 발생시킴
- 안전성을 위해 base와 limit 레지스터는 커널 모드에서만 수정 가능하도록 설계 (사용자 모드에서는 직접 변경 X)

### **메모리 과할당(over allocating)**

실제 메모리의 사이즈보다 더 큰 사이즈의 메모리를 프로세스에 할당한 상황

- 이런 경우에 페이지 기법과 같은 메모리 관리 기법을 통해 사용자가 눈치 채지 못하도록 눈속임을 통해 메모리를 할당해줌
- 하지만, 과할당 상황에 대해서 사용자를 속인 것을 들킬만한 상황이 존재함

1.  프로세스 실행 도중 페이지 폴트 발생

2.  페이지 폴트를 발생시킨 페이지 위치를 디스크에서 찾음

3.  메모리의 빈 프레임에 페이지를 올려야 하는데, 모든 메모리가 사용중이라 빈 프레임이 없음

이러한 과할당을 해결하기 위해선, 빈 프레임을 확보할 수 있어야 함

1. 메모리에 올라와 있는 한 프로세스를 종료시켜 빈 프레임을 얻음
2. 프로세스 하나를 swap out하고, 이 공간을 빈 프레임으로 활용

**둘 중 어느 방법 선택할까?**

- swapping 기법을 통해 공간을 바꿔치기하는 2번 방법과는 달리 1번은 사용자에게 페이징 시스템을 들킬 가능성이 매우 높아서 하면 안됨 (페이징 기법은 사용자 모르게 시스템 능률을 높이기 위해 선택한 일이므로 들키지 않게 처리해야한다)
- 따라서, 2번과 같은 해결책을 통해 페이지 교체가 이루어져야 함
